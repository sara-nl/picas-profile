PiCaS snakemake profile
-----------------------

The Pitch-Catch System, or PiCaS, work management tool that can work large amounts of jobs on a heterogeneous compute infrastructure. It  is developed by [SURF](http://www.surf.nl) and relies on a CouchDB server to keep track of the work itself. The user documentation can be found [here](https://doc.grid.surfsara.nl/en/latest/Pages/Practices/picas/picas_overview.html), and the source code with examples [here](https://github.com/sara-nl/picasclient/).

Integrating PiCaS (or picas) with snakemake allows you to send the work snakemake creates from the Snakefile to send it to any heterogeneous compute infrastructure that is connected to your picas database containing the work.

Setup
=====

This profile will allow snakemake to send its work to the CouchDB server, while the picas client (running on a worker node) will contact the server and perform the work stored in the DB.

To use the picas profile, in general you need three machines:

1. A machine running snakemake
2. A machine running the CouchDB server
3. A machine running the picas client

You can set up this screnario any way you want, you can even run the DB in a container, while running the client and snakemake on the same machine. In this case 1., 2. and 3. are the same machine. Usually, however, the DB is on a seperate machine and the client runs on a worker machine (slurm, grid, etc.).

##Prerequisites

To run snakemake with picas you need to setup the 3 components mentioned above.

### Install snakemake
Install snakemake following their documentation as described [here](https://snakemake.readthedocs.io/en/stable/getting_started/installation.html).

### Set up CouchDB
Set up a CouchDB in your compute infrastructure as described in the [PiCaS documentation](https://doc.grid.surfsara.nl/en/latest/Pages/Practices/picas/picas_overview.html#picas-server-1).

### Install picasclient
Install the PiCaS client on the machine that will be performing the work, such as the filesystem of a cluster, such that a worker node in the cluster can run the picas client. The installation instructions can be found [here](https://github.com/sara-nl/picasclient/).
As the code generated by snakemake contains calls to snakemake, picas will need to be installed into the (virtual, conda, mamba) environment that runs snakemake.


## Deploy profile

To deploy this profile, on the machine that you run Snakemake do:

```
mkdir -p ~/.config/snakemake
cd ~/.config/snakemake
cookiecutter https://github.com/sara-nl/picas-profile.git
```

When asked for the PiCaS information, insert the information needed to connect to the PiCaS instance.

Running
=======

The snakemake example is used to showcase the picas workflow.

First make sure you can run the Basic Workflow as given in the [snakemake documentation](https://snakemake.readthedocs.io/en/stable/tutorial/basics.html).
Once you have the basic snakemake example running and the whole stack given in de [Setup](#Setup) is installed, you can now run the example with:

```
snakemake --profile picas -j N ...
```

where N is the number of jobs you want to run in parallel, for the Basic example, you only have to use up to 3 as there are 3 parallel steps in the snakemake graph (A, B and C in the samples).

You will notice the jobs stall. This is because there is no client running to execute the code in the jobs. In the `examples` folder you will find the code to 
